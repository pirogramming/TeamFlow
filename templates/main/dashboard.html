{% extends "base.html" %}
{% load static %}

{% block title %}대시보드 - TeamFlow{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/main/dashboard.css' %}">
{% endblock %}

{% block content %}
<!-- CSRF 토큰 (JavaScript에서 사용) -->
{% csrf_token %}

<div class="page-container">
    <!-- 페이지 헤더 -->
    <div class="dashboard-header">
        <div class="page-title-group">
            <h1 class="page-title">대시보드</h1>
            <p class="page-subtitle">팀과 개인의 작업 현황을 한눈에 파악하세요</p>
        </div>
    </div>

    <!-- 메인 콘텐츠 -->
    <div class="dashboard-content">
        <!-- 상단 요약 카드들 -->
        <div class="summary-cards">
            <!-- 전체 진행률 -->
            <div class="summary-card">
                <div class="card-header">
                    <h3 class="card-title">전체 진행률</h3>
                </div>
                <div class="card-content">
                    <div class="progress-display">
                        <span class="progress-percentage" id="overall-progress">{{ total_progress }}%</span>
                        <div class="progress-bar">
                            <div class="progress-fill" id="overall-progress-fill" style="width: {{ total_progress }}%"></div>
                        </div>
                        <span class="progress-text" id="overall-progress-text">{{ completed_tasks_count }}/{{ total_tasks_count }}</span>
                    </div>
                </div>
            </div>

            <!-- 개인 완료율 -->
            <div class="summary-card">
                <div class="card-header">
                    <h3 class="card-title">개인 완료율</h3>
                </div>
                <div class="card-content">
                    <div class="progress-display">
                        <span class="progress-percentage" id="personal-progress">{{ personal_progress }}%</span>
                        <div class="progress-bar">
                            <div class="progress-fill" id="personal-progress-fill" style="width: {{ personal_progress }}%"></div>
                        </div>
                        <span class="progress-text" id="personal-progress-text">{{ personal_completed_count }}/{{ personal_tasks_count }}</span>
                    </div>
                    <p class="progress-description">내가 담당한 작업</p>
                </div>
            </div>

            <!-- 마감 임박 -->
            <div class="summary-card">
                <div class="card-header">
                    <h3 class="card-title">마감 임박</h3>
                </div>
                <div class="card-content">
                    <div class="deadline-display">
                        <div class="deadline-icon">
                            <svg fill="var(--danger-600)" viewBox="0 0 24 24" width="24" height="24">
                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                            </svg>
                        </div>
                        <span class="deadline-count" id="deadline-count">{{ deadline_imminent_count }}</span>
                        <span class="deadline-text">개 작업</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 작업 목록 -->
        <div class="tasks-section">
            <!-- 팀 작업 -->
            <div class="tasks-card">
                <div class="card-header">
                    <h3 class="card-title">팀 작업</h3>
                    <p class="card-subtitle">팀의 최근 작업 현황</p>
                </div>
                <div class="card-content">
                    <div class="task-status-tabs" data-scope="team">
                        <button type="button" class="task-status-tab active" data-scope="team" data-status="active">진행중</button>
                        <button type="button" class="task-status-tab" data-scope="team" data-status="completed">완료</button>
                    </div>
                    <div class="task-list" id="team-tasks">
                        {% for task in team_tasks %}
                        <div class="task-item">
                            <div class="task-content">
                                <div class="task-header">
                                    <span class="task-name">{{ task.name }}</span>
                                    <div class="task-meta">
                                        {% if task.is_deadline_imminent %}
                                        <span class="task-badge-urgent">마감 임박</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="task-details">
                                    <span class="task-assignee">
                                        담당자: {% if task.assignee %}{{ task.assignee.first_name|default:task.assignee.username }}{% else %}미정{% endif %}
                                    </span>
                                    {% if task.due_date %}
                                    <span class="task-separator">•</span>
                                    <span class="task-due-date">{{ task.due_date|date:"Y-m-d" }}</span>
                                    {% endif %}
                                </div>
                                {% if task.description %}
                                <div class="task-description">{{ task.description }}</div>
                                {% endif %}
                            </div>
                        </div>
                        {% empty %}
                        <p>팀 작업이 없습니다.</p>
                        {% endfor %}
                    </div>
                    <div class="task-actions">
                        <button type="button" id="team-tasks-toggle" class="btn-link small">더보기</button>
                    </div>
                </div>
            </div>

            <!-- 개인 작업 -->
            <div class="tasks-card">
                <div class="card-header">
                    <h3 class="card-title">개인 작업</h3>
                    <p class="card-subtitle">나의 개인 작업 현황</p>
                </div>
                <div class="card-content">
                    <div class="task-status-tabs" data-scope="personal">
                        <button type="button" class="task-status-tab active" data-scope="personal" data-status="active">진행중</button>
                        <button type="button" class="task-status-tab" data-scope="personal" data-status="completed">완료</button>
                    </div>
                    <div class="task-list" id="personal-tasks">
                        {% for task in personal_tasks %}
                        <div class="task-item">
                            <div class="task-content">
                                <div class="task-header">
                                    <span class="task-name">{{ task.name }}</span>
                                    <div class="task-meta">
                                        {% if task.is_deadline_imminent %}
                                        <span class="task-badge-urgent">마감 임박</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="task-details">
                                    {% if task.due_date %}
                                    <span class="task-due-date">{{ task.due_date|date:"Y-m-d" }}</span>
                                    {% endif %}
                                </div>
                                {% if task.description %}
                                <div class="task-description">{{ task.description }}</div>
                                {% endif %}
                            </div>
                        </div>
                        {% empty %}
                        <p>개인 작업이 없습니다.</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- 팀 현황 -->
        <div class="team-status-section">
            <div class="team-status-card">
                <div class="card-header">
                    <h3 class="card-title">팀 현황</h3>
                    <div class="invite-code-inline">
                        <span class="invite-label">초대 코드:</span>
                        <input type="text" id="invite-code-input" class="invite-code-input-small" readonly value="{{ team.invite_code|default:'------' }}">
                        <button class="copy-button-small" id="copy-invite-code" title="복사">
                            <svg fill="currentColor" viewBox="0 0 24 24" width="14" height="14">
                                <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="card-content">
                    <div class="team-members" id="team-members">
                        {% for member in team_members %}
                        <div class="team-member">
                            <div class="member-avatar">
                                <span class="avatar-text">{{ member.name|first }}</span>
                            </div>
                            <div class="member-info">
                                <span class="member-name">{{ member.name }}</span>
                                <span class="member-major">{{ member.major|default:"전공 미정" }}</span>
                                <span class="member-role">{{ member.role|default:"역할 미정" }}</span>
                            </div>
                        </div>
                        {% empty %}
                        <p>팀원 정보가 없습니다.</p>
                        {% endfor %}
                    </div>
                    <div class="task-actions">
                        <button type="button" id="personal-tasks-toggle" class="btn-link small">더보기</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/pages/main/dashboard.js' %}"></script>
{% endblock %}
