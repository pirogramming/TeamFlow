{% extends "base.html" %}
{% load static %}

{% block title %}역할 관리{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pages/main/roles.css' %}">
<meta name="user-id" content="{{ request.user.id }}">
{% endblock %}

{% block content %}
<div class="page-container">
    <div class="roles-header">
        <div class="page-title-group">
            <h1 class="page-title">역할 관리</h1>
            <p class="page-subtitle">팀원 역할을 등록하고 AI 추천으로 자동 배정해보세요</p>
        </div>
    </div>

    <!-- 탭 네비게이션 -->
    <div class="tab-navigation">
        <button class="tab-btn active" data-tab="ai-recommend">AI 추천</button>
        <button class="tab-btn" data-tab="direct-input">직접 입력</button>
    </div>

    <!-- AI 추천 탭 -->
    <div id="ai-recommend" class="tab-content active">
        <div class="ai-section">
            <h2>AI 역할 추천</h2>
            <p>팀원 각자 자신의 성향 정보를 제출하면, AI가 팀 전체의 역할을 중복 없이 배정합니다.</p>

            <!-- 등록된 역할이 없을 때 -->
            {% if not team_roles %}
            <div class="empty-roles-notice">
                <div class="empty-icon">⚠️</div>
                <h3>등록한 역할이 없어요</h3>
                <p>AI 역할 추천을 받기 전에 먼저 역할을 등록해주세요</p>
                <button class="btn-go-to-direct" onclick="switchTab('direct-input')">
                    <span>역할 등록하러 가기</span>
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
            </div>
            {% else %}
            <!-- AI 추천 폼 -->
            <div class="ai-form-container">
                <form id="ai-recommendation-form" class="ai-form">
                    <div class="form-group">
                        <label>전공</label>
                        <input type="text" name="major" value="{{ user_major }}" readonly>
                    </div>

                    <div class="form-group">
                        <label class="required">성향 (필수)</label>
                        <div class="checkbox-grid">
                            <label class="checkbox-item"><input type="checkbox" name="traits" value="리더십"><span>리더십</span></label>
                            <label class="checkbox-item"><input type="checkbox" name="traits" value="창의적"><span>창의적</span></label>
                            <label class="checkbox-item"><input type="checkbox" name="traits" value="논리적"><span>논리적</span></label>
                            <label class="checkbox-item"><input type="checkbox" name="traits" value="협력적"><span>협력적</span></label>
                            <label class="checkbox-item"><input type="checkbox" name="traits" value="책임감"><span>책임감</span></label>
                            <label class="checkbox-item"><input type="checkbox" name="traits" value="적극적"><span>적극적</span></label>
                            <label class="checkbox-item"><input type="checkbox" name="traits" value="신중함"><span>신중함</span></label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>선호 역할 (팀에서 등록된 역할, 선택사항)</label>
                        <div class="preferred-roles" id="preferred-roles">
                            {% for role in team_roles %}
                            <label class="checkbox-item">
                                <input type="checkbox" name="preferred_roles" value="{{ role.id }}">
                                <span>{{ role.name }}</span>
                            </label>
                            {% empty %}
                            <p class="no-roles-message">등록된 역할이 없습니다. 먼저 역할을 등록해주세요.</p>
                            {% endfor %}
                        </div>
                    </div>

                    <button type="submit" class="btn-ai-analyze">
                        <span>내 정보 제출하기</span>
                    </button>
                </form>

                <!-- ✨ 실시간 제출 현황 표시 영역 (신규 추가) -->
                <div id="ai-submission-status-container" class="submission-status-container">
                    <h3>실시간 제출 현황</h3>
                    <div id="submission-status">제출 현황: 0 / {{ team_members|length }}</div>
                    <div id="submitted-list"></div>
                    <button id="team-ai-assign-btn" class="btn btn-primary" disabled>
                        AI로 전체 역할 자동 배정
                    </button>
                    <small>모든 팀원이 정보를 제출하면 버튼이 활성화됩니다.</small>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- 직접 입력 탭 -->
    <div id="direct-input" class="tab-content">
        <div class="direct-section">
            <div class="section-header">
                <h2>역할 등록</h2>
                <button class="btn-add-role" onclick="openRoleModal()">
                    <span>+ 역할 등록</span>
                </button>
            </div>

            <div class="registered-roles">
                <h3>등록된 역할</h3>
                <div class="roles-list" id="roles-list">
                    {% for role in team_roles %}
                    <div class="role-item" data-role-id="{{ role.id }}">
                        <span class="role-name">{{ role.name }}</span>
                        <button class="role-delete-btn" onclick="deleteRole({{ role.id }})" title="역할 삭제">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6m0 0L6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    {% empty %}
                    <div class="empty-roles">
                        <p>등록된 역할이 없습니다.</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <div class="team-role-assignment" id="team-role-assignment" style="display: none;">
                <h3>팀원 역할 지정</h3>
                <p>등록된 역할을 팀원들에게 할당하세요</p>
                
                <div class="assignment-list">
                    {% for member in team_members %}
                    <div class="member-assignment-item" data-user-id="{{ member.user.id }}">
                        <div class="member-info">
                            <div class="member-avatar">{{ member.user.first_name|first|default:member.user.username|first }}</div>
                            <div class="member-details">
                                <h4>{{ member.user.first_name|default:member.user.username }}</h4>
                                <span class="member-major">{{ member.user.profile.major|default:"전공 미설정" }}</span>
                            </div>
                        </div>
                        <div class="role-assignment">
                            <select class="role-select" data-user-id="{{ member.user.id }}">
                                <option value="">역할 선택</option>
                                {% for role in team_roles %}
                                <option value="{{ role.id }}">{{ role.name }}</option>
                                {% endfor %}
                            </select>
                            <button class="btn-assign" onclick="assignRole({{ member.user.id }})">
                                지정하기
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- 팀원 현황 -->
    <div class="team-status">
        <h3>팀원 현황</h3>
        <div class="team-members-grid">
            {% for member in team_members %}
            <!-- ✨ data-user-name 속성을 추가했습니다. -->
            <div class="member-status-card" data-user-id="{{ member.user.id }}" data-user-name="{{ member.user.username }}">
                <div class="member-avatar">{{ member.user.first_name|first|default:member.user.username|first }}</div>
                <h4>{{ member.user.first_name|default:member.user.username }}</h4>
                <div class="team-role">
                    {% if member.user == team.owner %}팀장{% else %}팀원{% endif %}
                </div>
                {% if member.assigned_role %}
                <div class="assigned-role">{{ member.assigned_role.name }}</div>
                {% else %}
                    <div class="no-role">역할 미정</div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- 역할 등록 모달 -->
{% include 'includes/modals/role-modal.html' %}
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/pages/main/roles.js' %}"></script>
{% endblock %}
